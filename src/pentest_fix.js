const express = require('express');
const path = require('path');
const app = express();

// Security Headers Middleware
app.use((req, res, next) => {
  // Clickjacking protection VULN-001
  res.setHeader("X-Frame-Options", "SAMEORIGIN");
  app.use((req, res, next) => {
  res.setHeader("Content-Security-Policy", "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://fonts.gstatic.com; img-src 'self'; font-src 'self' https://fonts.googleapis.com https://fonts.gstatic.com; object-src 'none'; frame-ancestors 'self'");
  next();
});

  // Prevent MIME-sniffing VULN-004
  res.setHeader("X-Content-Type-Options", "nosniff");

  // HSTS (HTTPS only!) VULN-002
  res.setHeader("Strict-Transport-Security", "max-age=31536000; includeSubDomains");

  // Remove potential timestamp header VULN-003
  res.removeHeader("Last-Modified");

  // Prevent access to dotfiles like .env, .git VULN-010
  if (/\/\.[^\/]+/.test(req.url)) {
    return res.status(403).send("Access denied.");
  }

  next();
});

// Remove X-Powered-By header VULN-005
app.disable('x-powered-by');

// Serve static files VULN-006
app.use(express.static(path.join(__dirname, 'dist', 'renewable-energy-app'), {
  setHeaders: (res, filePath) => {
    if (/\.(js|css|png|jpg|jpeg|gif|svg|woff2?)$/i.test(filePath)) {
      // Cache static assets for 30 days
      res.setHeader('Cache-Control', 'public, max-age=2592000'); // 30 days
    } else {
      // Don't cache other static files (e.g. HTML)
      res.setHeader('Cache-Control', 'no-store');
    }
  }
}));

// Handle all other routes VULN-006
app.get('/*', (req, res) => {
  res.setHeader('Cache-Control', 'no-store');
  res.sendFile(path.resolve(__dirname, 'dist', 'renewable-energy-app', 'index.html'));
});



// Use environment variable for the port
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
